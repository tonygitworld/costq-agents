# Agent ä»£ç æ–‡ä»¶æ¸…å•

æœ¬æ–‡æ¡£è¯¦ç»†åˆ—å‡ºäº† Agent é‡æ„è¿‡ç¨‹ä¸­æ¶‰åŠçš„æ‰€æœ‰æ–‡ä»¶ï¼ŒåŒ…æ‹¬éœ€è¦è¿ç§»çš„æ–‡ä»¶ã€éœ€è¦ä¿ç•™/å†»ç»“çš„æ–‡ä»¶ã€ä»¥åŠä¾èµ–å…³ç³»ã€‚

## âš ï¸ å½“å‰ç°çŠ¶

### éƒ¨ç½²æƒ…å†µ
- âœ… **Frontend + Backend** â†’ éƒ¨ç½²åœ¨ EKS (å…±äº« Dockerfile)
- âœ… **Agent** â†’ ç‹¬ç«‹éƒ¨ç½²åœ¨ AgentCore Runtime
- âŒ **ä»£ç ä»“åº“** â†’ Agent ä»£ç ä»åœ¨ `backend/agent/`ï¼ˆä¸ Backend æ··åœ¨ä¸€èµ·ï¼‰

### Agent ä»£ç ä½ç½®
```
strands-agent-demo/  (å½“å‰å•ä½“ä»“åº“)
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ agent/  â¬…ï¸ Agent ä»£ç åœ¨è¿™é‡Œï¼ˆéœ€è¦æ‹†åˆ†ï¼‰
â”‚   â”‚   â”œâ”€â”€ agent_runtime.py
â”‚   â”‚   â”œâ”€â”€ agent_manager.py
â”‚   â”‚   â”œâ”€â”€ streaming_agent.py (å·²åºŸå¼ƒ)
â”‚   â”‚   â”œâ”€â”€ alert_agent.py (å·²åºŸå¼ƒ)
â”‚   â”‚   â””â”€â”€ prompts/  (æ¨¡å—åŒ–æç¤ºè¯ç›®å½•)
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ loader.py
â”‚   â”‚       â”œâ”€â”€ README.md
â”‚   â”‚       â”œâ”€â”€ core/
â”‚   â”‚       â”œâ”€â”€ aws/
â”‚   â”‚       â”œâ”€â”€ gcp/
â”‚   â”‚       â”œâ”€â”€ shared/
â”‚   â”‚       â”œâ”€â”€ examples/
â”‚   â”‚       â””â”€â”€ alert_agent/
â”‚   â”‚           â”œâ”€â”€ alert_prompts.py
â”‚   â”‚           â””â”€â”€ alert_execution_system.md
â”‚   â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ services/
â”‚   â””â”€â”€ mcp/
â”œâ”€â”€ frontend/
â””â”€â”€ deployment/
    â”œâ”€â”€ agentcore/
    â”œâ”€â”€ aws-policies/
    â”œâ”€â”€ cloudformation/
    â”œâ”€â”€ k8s/
    â””â”€â”€ scripts/
```

### MCP Server æ‹†åˆ†æƒ…å†µ

**âœ… å·²æ‹†åˆ†ï¼ˆGateway éƒ¨ç½²ï¼‰**ï¼š

| MCP Server | å½“å‰çŠ¶æ€ | éƒ¨ç½²æ–¹å¼ | è¿æ¥æ–¹å¼ |
|-----------|---------|---------|---------|
| `billing-cost-management` | âœ… ç‹¬ç«‹ä»“åº“ | AgentCore Gateway | HTTP + SigV4 |
| `risp` | âœ… ç‹¬ç«‹ä»“åº“ | AgentCore Gateway | HTTP + SigV4 |
| `cloudtrail` | âœ… ç‹¬ç«‹ä»“åº“ | AgentCore Gateway | HTTP + SigV4 |

**âš ï¸ æœªæ‹†åˆ†ï¼ˆæœ¬åœ° stdioï¼‰**ï¼š

| MCP Server | å½“å‰ä½ç½® | è¿ç§»ç›®æ ‡ | è¿æ¥æ–¹å¼ |
|-----------|---------|---------|---------|
| `common-tools` | `backend/mcp/common_tools_mcp_server/` | `costq-agents/mcp/common_tools/` | stdio (å­è¿›ç¨‹) |
| `alert` | `backend/mcp/alert_mcp_server/` | `costq-agents/mcp/alert/` | stdio (å­è¿›ç¨‹) |
| `send-email` | `backend/mcp/send_email_mcp_server/` | `costq-agents/mcp/send_email/` | stdio (å­è¿›ç¨‹) |
| `gcp-cost` | `backend/mcp/gcp_cost_mcp_server/` | `costq-agents/mcp/gcp_cost/` | stdio (å­è¿›ç¨‹) |

**ğŸ“¦ å®˜æ–¹åŒ…ï¼ˆPyPI å®‰è£…ï¼‰**ï¼š

| MCP Server | å®‰è£…æ–¹å¼ | è¯´æ˜ |
|-----------|---------|------|
| `pricing` | `pip install aws-pricing-mcp-server` | æ— éœ€å¤åˆ¶ä»£ç  |
| `documentation` | `pip install aws-documentation-mcp-server` | æ— éœ€å¤åˆ¶ä»£ç  |

## ğŸ“‹ ç›®å½•

- [1. æ ¸å¿ƒ Agent ä»£ç ](#1-æ ¸å¿ƒ-agent-ä»£ç )
- [2. é…ç½®å’Œå·¥å…·æ¨¡å—](#2-é…ç½®å’Œå·¥å…·æ¨¡å—)
- [3. æ•°æ®åº“æ¨¡å—](#3-æ•°æ®åº“æ¨¡å—)
- [4. æœåŠ¡å±‚æ¨¡å—](#4-æœåŠ¡å±‚æ¨¡å—)
- [5. MCP æ¨¡å—](#5-mcp-æ¨¡å—)
- [6. å·²åºŸå¼ƒæ–‡ä»¶ï¼ˆä»…è®°å½•ï¼Œä¸åœ¨ monorepo åˆ é™¤ï¼‰](#6-å·²åºŸå¼ƒæ–‡ä»¶ä»…è®°å½•ä¸åœ¨-monorepo-åˆ é™¤)
- [7. Backend ä¿ç•™çš„æ–‡ä»¶](#7-backend-ä¿ç•™çš„æ–‡ä»¶)

---

## 1. æ ¸å¿ƒ Agent ä»£ç 

### 1.1 Agent Runtimeï¼ˆå…¥å£æ–‡ä»¶ï¼‰

**æ–‡ä»¶**: `backend/agent/agent_runtime.py` â†’ `agent/runtime.py`

**MCP é…ç½®å…¥å£**: `config/mcp_config.json`ï¼ˆå½“å‰ monorepo ä½¿ç”¨çš„ MCP é…ç½®ï¼›è¿ç§»æ—¶åŒæ­¥åˆ°æ–°ä»“åº“ï¼‰

**ä»£ç è¡Œæ•°**: ~1000 è¡Œ

**æ ¸å¿ƒåŠŸèƒ½**:
1. AgentCore Runtime å…¥å£å‡½æ•° `@app.entrypoint async def invoke(payload)`
2. Payload è§£æå’ŒéªŒè¯
3. æ•°æ®åº“æŸ¥è¯¢ï¼ˆè·å–è´¦å·ä¿¡æ¯ï¼‰
4. å‡­è¯è·å–ï¼š
   - IAM Role AssumeRole
   - AKSK è§£å¯†
   - GCP Service Account è§£å¯†
5. ç¯å¢ƒå˜é‡éš”ç¦»ï¼ˆ`additional_env` å­—å…¸ï¼‰
6. MCP å®¢æˆ·ç«¯åˆ›å»ºï¼ˆæœ¬åœ° + Gatewayï¼‰
7. Agent åˆ›å»ºï¼ˆBedrockModel + Tools + Memoryï¼‰
8. Agent æµå¼æ‰§è¡Œï¼ˆ`stream_async`ï¼‰
9. äº‹ä»¶è¿‡æ»¤ï¼ˆ`filter_event`ï¼‰
10. èµ„æºæ¸…ç†

**å…³é”®ä¾èµ–**:
```python
from bedrock_agentcore import BedrockAgentCoreApp
from opentelemetry import baggage, context, trace

from backend.agent.agent_manager import AgentManager
from backend.mcp.mcp_manager import MCPManager
from backend.database import get_db
from backend.config.settings import settings
from backend.services.credential_manager import get_credential_manager
from backend.services.gcp_credential_manager import get_gcp_credential_manager
from backend.services.iam_role_session_factory import IAMRoleSessionFactory
from backend.utils.aws_session_factory import AWSSessionFactory
```

**è¿ç§»æ³¨æ„äº‹é¡¹**:
- âœ… ä¿æŒå®Œæ•´æ€§ï¼Œè¿™æ˜¯ Agent çš„æ ¸å¿ƒå…¥å£
- âš ï¸ æ›´æ–°å¯¼å…¥è·¯å¾„ï¼š`backend.xxx` â†’ `xxx`
- âœ… ä¿ç•™æ‰€æœ‰ç¯å¢ƒå˜é‡éš”ç¦»é€»è¾‘
- âœ… ä¿ç•™ OpenTelemetry æ—¥å¿—é›†æˆ

---

### 1.2 Agent Managerï¼ˆAgent ç®¡ç†å™¨ï¼‰

**æ–‡ä»¶**: `backend/agent/agent_manager.py` â†’ `agent/manager.py`

**ä»£ç è¡Œæ•°**: ~400 è¡Œ

**æ ¸å¿ƒåŠŸèƒ½**:
1. BedrockModel å•ä¾‹ç®¡ç†
2. Prompt Caching é…ç½®
3. Agent åˆ›å»ºï¼ˆæ—  Memoryï¼‰
4. Agent åˆ›å»ºï¼ˆå¸¦ Memoryï¼‰
   - AgentCoreMemorySessionManager
   - SlidingWindowConversationManager
5. å¼‚å¸¸å¤„ç†å’Œé™çº§ï¼ˆMemory å¤±è´¥å›é€€ï¼‰

**å…³é”®é…ç½®**:
```python
# Bedrock é…ç½®
BEDROCK_MODEL_ID = "us.anthropic.claude-sonnet-4-20250514-v1:0"
BEDROCK_REGION = "us-west-2"
BEDROCK_CROSS_ACCOUNT_ROLE_ARN = "arn:aws:iam::905418431228:role/..."

# Memory é…ç½®
MEMORY_RESOURCE_ID = "CostQ_Pro-77Jh0OAr3A"

# Prompt Caching
BEDROCK_ENABLE_PROMPT_CACHING = True
BEDROCK_CACHE_PROMPT = "default"
BEDROCK_CACHE_TOOLS = "default"
```

**è¿ç§»æ³¨æ„äº‹é¡¹**:
- âœ… ä¿æŒå•ä¾‹ BedrockModel è®¾è®¡
- âœ… ä¿ç•™ Memory å¼‚å¸¸å¤„ç†å’Œé™çº§é€»è¾‘
- âœ… ä¿ç•™ Calculator å·¥å…·è‡ªåŠ¨æ·»åŠ 

---

### 1.3 Promptsï¼ˆæç¤ºè¯ï¼‰

#### æ–‡ä»¶ 1: `backend/agent/prompts/__init__.py`

**åŠŸèƒ½**: æç¤ºè¯å¯¼å‡ºå…¥å£ï¼ˆå¯¹å¤–æš´éœ²åŠ è½½æ¥å£ï¼‰

#### æ–‡ä»¶ 2: `backend/agent/prompts/loader.py`

**åŠŸèƒ½**: æç¤ºè¯åŠ è½½ä¸ç¼“å­˜ï¼ˆæŒ‰ç›®å½•æ¨¡å—åŒ–åŠ è½½ï¼‰

#### æ–‡ä»¶ 3: `backend/agent/prompts/README.md`

**åŠŸèƒ½**: æç¤ºè¯ç›®å½•ç»“æ„è¯´æ˜ä¸ç´¢å¼•

#### æ¨¡å—åŒ–ç›®å½•

- `backend/agent/prompts/core/`ï¼šæ ¸å¿ƒç³»ç»Ÿçº¦æŸ
- `backend/agent/prompts/aws/`ï¼šAWS å¯¹è¯æç¤ºè¯ï¼ˆå«ç¤ºä¾‹ï¼‰
- `backend/agent/prompts/gcp/`ï¼šGCP æˆæœ¬ç›¸å…³æç¤ºè¯
- `backend/agent/prompts/shared/`ï¼šè·¨åœºæ™¯å…±äº«ç‰‡æ®µ
- `backend/agent/prompts/examples/`ï¼šFew-shot ç¤ºä¾‹
- `backend/agent/prompts/alert_agent/`ï¼šå‘Šè­¦åœºæ™¯æç¤ºè¯
  - `alert_prompts.py`
  - `alert_execution_system.md`

**è¿ç§»æ³¨æ„äº‹é¡¹**:
- âœ… å®Œæ•´å¤åˆ¶æ¨¡å—åŒ–ç›®å½•ï¼Œä¸åšå†…å®¹ä¿®æ”¹
- âœ… ä¿ç•™æ‰€æœ‰ç¤ºä¾‹ï¼ˆç”¨äº Prompt Cachingï¼‰

---

### 1.4 Streaming Agentï¼ˆå·²åºŸå¼ƒï¼‰

**æ–‡ä»¶**: `backend/agent/streaming_agent.py`

**çŠ¶æ€**: âŒ **åºŸå¼ƒï¼Œä¸è¿ç§»**

**åŸå› **:
- æ—©æœŸ WebSocket æ¨¡å¼çš„å®ç°
- å·²è¢« AgentCore Runtime çš„æµå¼æ¨¡å¼æ›¿ä»£
- `agent_runtime.py` ç›´æ¥ä½¿ç”¨ `agent.stream_async()`

**æ“ä½œ**: æ—§ä»“åº“ä¸åšåˆ é™¤ï¼Œä¿ç•™å¾…æ•´ä½“åºŸå¼ƒæ—¶å¤„ç†

---

### 1.5 Alert Agentï¼ˆå·²åºŸå¼ƒï¼‰

**æ–‡ä»¶**: `backend/agent/alert_agent.py`

**çŠ¶æ€**: âŒ **åºŸå¼ƒï¼Œä¸è¿ç§»**

**åŸå› **:
- æ—©æœŸç‹¬ç«‹å‘Šè­¦ Agent å®ç°
- å·²åˆå¹¶åˆ° `agent_runtime.py` çš„ `prompt_type="alert"` å‚æ•°
- é€šè¿‡ä¸åŒæç¤ºè¯åŒºåˆ†å¯¹è¯å’Œå‘Šè­¦åœºæ™¯

**æ“ä½œ**: æ—§ä»“åº“ä¸åšåˆ é™¤ï¼Œä¿ç•™å¾…æ•´ä½“åºŸå¼ƒæ—¶å¤„ç†

---

## 2. é…ç½®å’Œå·¥å…·æ¨¡å—

### 2.1 Settingsï¼ˆç»Ÿä¸€é…ç½®ï¼‰

**æ–‡ä»¶**: `backend/config/settings.py` â†’ `config/settings.py`

**ä»£ç è¡Œæ•°**: ~500 è¡Œ

**éœ€è¦ä¿ç•™çš„é…ç½®**:
```python
# âœ… ç¯å¢ƒæ ‡è¯†
ENVIRONMENT: str  # local/development/staging/production
DEBUG: bool

# âœ… AWS é…ç½®
AWS_REGION: str = "ap-northeast-1"
AWS_PROFILE: str | None

# âœ… Bedrock é…ç½®
BEDROCK_MODEL_ID: str
BEDROCK_REGION: str = "us-west-2"
BEDROCK_CROSS_ACCOUNT_ROLE_ARN: str | None
BEDROCK_ASSUME_ROLE_DURATION: int = 3600

# âœ… Prompt Caching
BEDROCK_ENABLE_PROMPT_CACHING: bool = True
BEDROCK_CACHE_PROMPT: str = "default"
BEDROCK_CACHE_TOOLS: str = "default"

# âœ… MCP é…ç½®
AWS_MCP_SERVERS: list[str]
AWS_GATEWAY_MCP_SERVERS: list[str]
GCP_MCP_SERVERS: list[str]

# âœ… æ•°æ®åº“é…ç½®
DATABASE_URL: str | None
RDS_SECRET_NAME: str

# âœ… AgentCore é…ç½®
MEMORY_RESOURCE_ID: str | None
AGENTCORE_RUNTIME_ARN: str
AGENTCORE_REGION: str

# âœ… Gateway MCP é…ç½®
COSTQ_AWS_MCP_SERVERS_GATEWAY_URL: str | None
GATEWAY_SERVICE: str = "bedrock-agentcore"

# âœ… åŠ å¯†é…ç½®
ENCRYPTION_KEY: str | None

# âœ… æ—¥å¿—é…ç½®
LOG_LEVEL: str = "INFO"
FASTMCP_LOG_LEVEL: str = "WARNING"
```

**æ–°ä»“åº“éœ€è¦ç§»é™¤çš„é…ç½®**ï¼ˆæ—§ä»“åº“ä¸åšæ”¹åŠ¨ï¼‰:
```python
# âŒ JWT å’Œè®¤è¯ï¼ˆBackend ä¸“ç”¨ï¼‰
JWT_SECRET_KEY: str
JWT_ALGORITHM: str
FRONTEND_ACCESS_TOKEN_EXPIRE_MINUTES: int
FRONTEND_REFRESH_TOKEN_EXPIRE_MINUTES: int

# âŒ CORSï¼ˆBackend ä¸“ç”¨ï¼‰
CORS_ORIGINS: str

# âŒ å‰ç«¯é…ç½®ï¼ˆBackend ä¸“ç”¨ï¼‰
FRONTEND_URL: str

# âŒ API é…ç½®ï¼ˆBackend ä¸“ç”¨ï¼‰
APP_NAME: str
APP_VERSION: str
API_PREFIX: str
```

**è¿ç§»æ³¨æ„äº‹é¡¹**:
- âœ… ä¿ç•™æ‰€æœ‰ Bedrockã€Memoryã€MCP ç›¸å…³é…ç½®
- âœ… ä¿ç•™ç¯å¢ƒåˆ¤æ–­æ–¹æ³•ï¼š`is_production`, `is_local`, `use_iam_role`
- âœ… ä¿ç•™ Secrets Manager è¯»å–é€»è¾‘ï¼š`get_database_url()`
- âŒ ä»…åœ¨æ–°ä»“åº“åˆ é™¤ Backend/Frontend ä¸“ç”¨é…ç½®ï¼ˆmonorepo ä¸åšä¿®æ”¹ï¼‰

---

### 2.2 AWS Secretsï¼ˆå¯†é’¥ç®¡ç†ï¼‰

**æ–‡ä»¶**: `backend/config/aws_secrets.py` â†’ `config/aws_secrets.py`

**ä»£ç è¡Œæ•°**: ~150 è¡Œ

**æ ¸å¿ƒåŠŸèƒ½**:
1. Secrets Manager å®¢æˆ·ç«¯ç®¡ç†
2. RDS å¯†é’¥è¯»å–å’Œè§£æ
3. æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²æ„å»º
4. IAM Role å’Œ Profile è‡ªåŠ¨åˆ‡æ¢

**å…³é”®æ–¹æ³•**:
```python
class SecretsManager:
    def get_secret(self, secret_name: str) -> dict
    def build_database_url(self, secret_name: str) -> str
```

**è¿ç§»æ³¨æ„äº‹é¡¹**:
- âœ… å®Œæ•´å¤åˆ¶ï¼Œä¿æŒåŠŸèƒ½ä¸€è‡´
- âœ… ç¡®ä¿ IAM Role å’Œ Profile åˆ‡æ¢é€»è¾‘æ­£ç¡®

---

## 3. æ•°æ®åº“æ¨¡å—

### 3.1 Database Connectionï¼ˆæ•°æ®åº“è¿æ¥ï¼‰

**æ–‡ä»¶**: `backend/database.py` â†’ `database/connection.py`

**ä»£ç è¡Œæ•°**: ~200 è¡Œ

**æ ¸å¿ƒåŠŸèƒ½**:
1. SQLAlchemy Engine åˆ›å»º
2. Session å·¥å‚
3. ä¾èµ–æ³¨å…¥ï¼š`get_db()`

**å…³é”®ä»£ç **:
```python
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

engine = create_engine(
    settings.get_database_url(),
    pool_size=5,
    max_overflow=10,
    pool_pre_ping=True
)

SessionLocal = sessionmaker(bind=engine)

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

**è¿ç§»æ³¨æ„äº‹é¡¹**:
- âœ… ä¿æŒè¿æ¥æ± é…ç½®
- âœ… ä¿ç•™ `pool_pre_ping` (æ£€æµ‹æ–­çº¿é‡è¿)
- âœ… ç¡®ä¿ä½¿ç”¨ Secrets Manager è¯»å–å¯†ç 

---

### 3.2 Database Modelsï¼ˆæ•°æ®åº“æ¨¡å‹ï¼‰

#### æ–‡ä»¶ 1: `backend/models/aws_account.py` â†’ `database/models/aws_account.py`

**ä»£ç è¡Œæ•°**: ~100 è¡Œ

**æ¨¡å‹**: `AWSAccount`

**å­—æ®µ**:
```python
class AWSAccount(Base):
    __tablename__ = "aws_accounts"

    id = Column(UUID, primary_key=True)
    account_id = Column(String(12))  # AWS 12ä½æ•°å­—è´¦å·
    role_arn = Column(String(255))
    org_id = Column(UUID)
    region = Column(String(50))
    auth_type = Column(String(20))  # "iam_role" | "aksk"
    access_key_id = Column(String(128))
    secret_access_key_encrypted = Column(Text)
    created_at = Column(DateTime)
    updated_at = Column(DateTime)
```

**è¿ç§»æ³¨æ„äº‹é¡¹**:
- âœ… å®Œæ•´å¤åˆ¶ï¼Œä¿æŒ Schema ä¸€è‡´

#### æ–‡ä»¶ 2: `backend/models/gcp_account.py` â†’ `database/models/gcp_account.py`

**ä»£ç è¡Œæ•°**: ~80 è¡Œ

**æ¨¡å‹**: `GCPAccount`

**å­—æ®µ**:
```python
class GCPAccount(Base):
    __tablename__ = "gcp_accounts"

    id = Column(UUID, primary_key=True)
    project_id = Column(String(255))
    account_name = Column(String(255))
    credentials_encrypted = Column(Text)
    org_id = Column(UUID)
    created_at = Column(DateTime)
    updated_at = Column(DateTime)
```

**è¿ç§»æ³¨æ„äº‹é¡¹**:
- âœ… å®Œæ•´å¤åˆ¶ï¼Œä¿æŒ Schema ä¸€è‡´

---

### 3.3 å…¶ä»–æ¨¡å‹ï¼ˆä¸è¿ç§»ï¼‰

ä»¥ä¸‹æ¨¡å‹ä»… Backend ä½¿ç”¨ï¼Œä¸è¿ç§»åˆ° Agent ä»“åº“ï¼š

- âŒ `backend/models/user.py` - ç”¨æˆ·æ¨¡å‹
- âŒ `backend/models/chat_session.py` - èŠå¤©ä¼šè¯
- âŒ `backend/models/chat_message.py` - èŠå¤©æ¶ˆæ¯
- âŒ `backend/models/alert.py` - å‘Šè­¦è§„åˆ™
- âŒ `backend/models/prompt_template.py` - æç¤ºè¯æ¨¡æ¿

---

## 4. æœåŠ¡å±‚æ¨¡å—

### 4.1 Credential Managerï¼ˆå‡­è¯ç®¡ç†ï¼‰

**æ–‡ä»¶**: `backend/services/credential_manager.py` â†’ `services/credential_manager.py`

**ä»£ç è¡Œæ•°**: ~150 è¡Œ

**æ ¸å¿ƒåŠŸèƒ½**:
1. Fernet åŠ å¯†/è§£å¯†
2. AKSK åŠ å¯†å­˜å‚¨
3. å¯†é’¥éªŒè¯

**å…³é”®æ–¹æ³•**:
```python
class CredentialManager:
    def encrypt_secret_key(self, secret_key: str) -> str
    def decrypt_secret_key(self, encrypted_key: str) -> str
    def validate_encryption_key(self) -> bool
```

**ä¾èµ–**:
```python
from cryptography.fernet import Fernet
from backend.config.settings import settings
```

**è¿ç§»æ³¨æ„äº‹é¡¹**:
- âœ… å®Œæ•´å¤åˆ¶ï¼Œä¿æŒåŠ å¯†ç®—æ³•ä¸€è‡´
- âœ… ç¡®ä¿ `ENCRYPTION_KEY` ç¯å¢ƒå˜é‡æ­£ç¡®ä¼ é€’

---

### 4.2 GCP Credential Managerï¼ˆGCP å‡­è¯ç®¡ç†ï¼‰

**æ–‡ä»¶**: `backend/services/gcp_credential_manager.py` â†’ `services/gcp_credential_manager.py`

**ä»£ç è¡Œæ•°**: ~120 è¡Œ

**æ ¸å¿ƒåŠŸèƒ½**:
1. GCP Service Account JSON åŠ å¯†/è§£å¯†
2. JSON æ ¼å¼éªŒè¯

**å…³é”®æ–¹æ³•**:
```python
class GCPCredentialManager:
    def encrypt_credentials(self, credentials: dict) -> str
    def decrypt_credentials(self, encrypted_credentials: str) -> dict
```

**è¿ç§»æ³¨æ„äº‹é¡¹**:
- âœ… å®Œæ•´å¤åˆ¶ï¼Œä¿æŒåŠ å¯†ç®—æ³•ä¸€è‡´

---

### 4.3 IAM Role Session Factoryï¼ˆIAM Role å‡­è¯ï¼‰

**æ–‡ä»¶**: `backend/services/iam_role_session_factory.py` â†’ `services/iam_role_session_factory.py`

**ä»£ç è¡Œæ•°**: ~250 è¡Œ

**æ ¸å¿ƒåŠŸèƒ½**:
1. AssumeRole è·å–ä¸´æ—¶å‡­è¯
2. å‡­è¯è‡ªåŠ¨åˆ·æ–°
3. å•ä¾‹æ¨¡å¼ç®¡ç†

**å…³é”®æ–¹æ³•**:
```python
class IAMRoleSessionFactory:
    @classmethod
    def get_instance(
        cls,
        account_id: str,
        role_arn: str,
        external_id: str | None,
        region: str
    ) -> "IAMRoleSessionFactory"

    def get_current_credentials(self) -> dict:
        """è¿”å› {access_key_id, secret_access_key, session_token}"""
```

**å‡­è¯åˆ·æ–°**:
- ä¸´æ—¶å‡­è¯æœ‰æ•ˆæœŸï¼š1 å°æ—¶
- æå‰ 5 åˆ†é’Ÿåˆ·æ–°ï¼ˆé¿å…è¿‡æœŸï¼‰
- è‡ªåŠ¨é‡è¯•æœºåˆ¶

**è¿ç§»æ³¨æ„äº‹é¡¹**:
- âœ… å®Œæ•´å¤åˆ¶ï¼Œä¿æŒåˆ·æ–°é€»è¾‘
- âœ… ç¡®ä¿å•ä¾‹æ¨¡å¼æ­£ç¡®

---

### 4.4 AWS Session Factoryï¼ˆBedrock è·¨è´¦å·ï¼‰

**æ–‡ä»¶**: `backend/utils/aws_session_factory.py` â†’ `utils/aws_session_factory.py`

**ä»£ç è¡Œæ•°**: ~200 è¡Œ

**æ ¸å¿ƒåŠŸèƒ½**:
1. Bedrock è·¨è´¦å· AssumeRole
2. ä½¿ç”¨ Runtime IAM Role ä½œä¸ºå‡­è¯æº
3. RefreshableCredentials è‡ªåŠ¨åˆ·æ–°

**å…³é”®æ–¹æ³•**:
```python
class AWSSessionFactory:
    @classmethod
    def get_instance(
        cls,
        role_arn: str,
        region: str,
        role_session_name: str,
        duration_seconds: int
    ) -> "AWSSessionFactory"

    def get_session(self) -> boto3.Session
```

**è¿ç§»æ³¨æ„äº‹é¡¹**:
- âœ… å®Œæ•´å¤åˆ¶ï¼Œä¿æŒåˆ·æ–°é€»è¾‘
- âœ… ç¡®ä¿ä¸æ±¡æŸ“ `os.environ`ï¼ˆä½¿ç”¨ `boto3.Session` éš”ç¦»ï¼‰

---

### 4.5 Streamable HTTP SigV4ï¼ˆGateway MCP è®¤è¯ï¼‰

**æ–‡ä»¶**: `backend/services/streamable_http_sigv4.py` â†’ `services/streamable_http_sigv4.py`

**ä»£ç è¡Œæ•°**: ~150 è¡Œ

**æ ¸å¿ƒåŠŸèƒ½**:
1. HTTP è¯·æ±‚ SigV4 ç­¾å
2. æ”¯æŒæµå¼å“åº”ï¼ˆSSEï¼‰
3. è‡ªåŠ¨ä½¿ç”¨å½“å‰è¿›ç¨‹å‡­è¯

**å…³é”®ä»£ç **:
```python
class StreamableHTTPSigV4Transport:
    def __init__(
        self,
        base_url: str,
        service: str,
        region: str
    ):
        self.base_url = base_url
        self.service = service
        self.region = region

    async def send_request(self, request: dict) -> AsyncIterator[dict]:
        # ä½¿ç”¨ httpx å‘é€è¯·æ±‚
        # ä½¿ç”¨ aws_request_auth è¿›è¡Œ SigV4 ç­¾å
        # æµå¼è¯»å–å“åº”
```

**ä¾èµ–**:
```python
from aws_request_auth import AWSV4Sign
import httpx
```

**è¿ç§»æ³¨æ„äº‹é¡¹**:
- âœ… å®Œæ•´å¤åˆ¶ï¼Œä¿æŒç­¾åé€»è¾‘
- âœ… ç¡®ä¿ä½¿ç”¨ Runtime IAM Roleï¼ˆä¸ä½¿ç”¨æŸ¥è¯¢è´¦å·å‡­è¯ï¼‰

---

### 4.6 Env Isolation Validatorï¼ˆç¯å¢ƒå˜é‡éš”ç¦»éªŒè¯ï¼‰

**æ–‡ä»¶**: `backend/utils/env_isolation_validator.py` â†’ `utils/env_isolation_validator.py`

**ä»£ç è¡Œæ•°**: ~80 è¡Œ

**æ ¸å¿ƒåŠŸèƒ½**:
1. éªŒè¯ `os.environ` æœªè¢«æ±¡æŸ“
2. æ£€æŸ¥ Runtime IAM Role å‡­è¯æœªè¢«è¦†ç›–
3. è®°å½•è¯¦ç»†æ—¥å¿—

**å…³é”®æ–¹æ³•**:
```python
def verify_env_isolation(phase: str) -> bool:
    """
    éªŒè¯ç¯å¢ƒå˜é‡éš”ç¦»æ˜¯å¦æˆåŠŸ

    Args:
        phase: æ£€æŸ¥é˜¶æ®µï¼ˆå¦‚ "after_mcp_creation"ï¼‰

    Returns:
        True: éš”ç¦»æˆåŠŸï¼Œos.environ æœªè¢«æ±¡æŸ“
        False: éš”ç¦»å¤±è´¥ï¼Œå‘ç°æ±¡æŸ“
    """
```

**è¿ç§»æ³¨æ„äº‹é¡¹**:
- âœ… å®Œæ•´å¤åˆ¶ï¼Œä¿æŒéªŒè¯é€»è¾‘
- âœ… åœ¨å…³é”®æ­¥éª¤åè°ƒç”¨éªŒè¯

---

### 4.7 ä¸è¿ç§»çš„æœåŠ¡æ¨¡å—

ä»¥ä¸‹æœåŠ¡ä»… Backend ä½¿ç”¨ï¼Œä¸è¿ç§»ï¼š

- âŒ `backend/services/agentcore_client.py` - AgentCore Runtime è°ƒç”¨å®¢æˆ·ç«¯ï¼ˆBackend â†’ Runtimeï¼‰
- âŒ `backend/services/chat_storage_*.py` - èŠå¤©è®°å½•å­˜å‚¨
- âŒ `backend/services/audit_logger.py` - å®¡è®¡æ—¥å¿—
- âŒ `backend/services/alert_scheduler.py` - å‘Šè­¦è°ƒåº¦å™¨
- âŒ `backend/services/email_service.py` - é‚®ä»¶æœåŠ¡
- âŒ `backend/services/user_storage_*.py` - ç”¨æˆ·å­˜å‚¨
- âŒ `backend/services/account_storage_*.py` - è´¦å·å­˜å‚¨ï¼ˆCRUDï¼‰
- âŒ `backend/services/resource_manager.py` - èµ„æºç®¡ç†ï¼ˆå¹¶å‘é™åˆ¶ï¼‰

**åŸå› **ï¼šè¿™äº›æœåŠ¡æ˜¯ Backend ä¸šåŠ¡é€»è¾‘çš„ä¸€éƒ¨åˆ†ï¼ŒAgent ä¸éœ€è¦ç›´æ¥è°ƒç”¨ã€‚Agent é€šè¿‡æ•°æ®åº“ç›´æ¥æŸ¥è¯¢è´¦å·ä¿¡æ¯å³å¯ã€‚

---

## 5. MCP æ¨¡å—

### 5.1 MCP Managerï¼ˆMCP å®¢æˆ·ç«¯ç®¡ç†ï¼‰

**æ–‡ä»¶**: `backend/mcp/mcp_manager.py` â†’ `mcp/manager.py`

**ä»£ç è¡Œæ•°**: ~400 è¡Œ

**æ ¸å¿ƒåŠŸèƒ½**:
1. åˆ›å»ºæœ¬åœ° MCP å®¢æˆ·ç«¯ï¼ˆstdioï¼‰
2. åˆ›å»º Gateway MCP å®¢æˆ·ç«¯ï¼ˆHTTP + SigV4ï¼‰
3. å·¥å…·åˆ—è¡¨è·å–å’Œåˆ†é¡µ
4. è¿æ¥æ± ç®¡ç†

**å…³é”®æ–¹æ³•**:
```python
class MCPManager:
    def create_all_clients(
        self,
        server_types: list[str],
        additional_env: dict[str, str] | None = None
    ) -> dict[str, Any]:
        """åˆ›å»ºæ‰€æœ‰æœ¬åœ° MCP å®¢æˆ·ç«¯"""

    def create_gateway_client(self, name: str) -> Any:
        """åˆ›å»º Gateway MCP å®¢æˆ·ç«¯"""

    def get_full_tools_list(self, client: Any) -> list:
        """è·å–å®Œæ•´å·¥å…·åˆ—è¡¨ï¼ˆå¤„ç†åˆ†é¡µï¼‰"""
```

**MCP é…ç½®æ˜ å°„**:
```python
MCP_SERVER_MODULES = {
    "common-tools": "backend.mcp.common_tools_mcp_server.server",
    "pricing": "aws_pricing",  # å®˜æ–¹åŒ…
    "documentation": "aws_documentation",  # å®˜æ–¹åŒ…
    "alert": "backend.mcp.alert_mcp_server.server",
    "send-email": "backend.mcp.send_email_mcp_server.server",
    "gcp-cost": "backend.mcp.gcp_cost_mcp_server.server",
}
```

**è¿ç§»æ³¨æ„äº‹é¡¹**:
- âœ… å®Œæ•´å¤åˆ¶ï¼Œä¿æŒ MCP é…ç½®ä¸€è‡´
- âœ… æ›´æ–°æ¨¡å—è·¯å¾„ï¼š`backend.mcp.xxx` â†’ `mcp.xxx`
- âœ… ç¡®ä¿ç¯å¢ƒå˜é‡éš”ç¦»ä¼ é€’é€»è¾‘æ­£ç¡®

---

### 5.2 Connection Poolï¼ˆGateway MCP è¿æ¥æ± ï¼‰

**æ–‡ä»¶**: `backend/mcp/connection_pool.py` â†’ `mcp/connection_pool.py`

**ä»£ç è¡Œæ•°**: ~100 è¡Œ

**æ ¸å¿ƒåŠŸèƒ½**:
1. httpx è¿æ¥æ± å¤ç”¨
2. Gateway MCP è¿æ¥ç®¡ç†
3. è¶…æ—¶å’Œé‡è¯•é…ç½®

**å…³é”®ä»£ç **:
```python
class ConnectionPool:
    def __init__(self):
        self.client = httpx.AsyncClient(
            timeout=30.0,
            limits=httpx.Limits(
                max_keepalive_connections=10,
                max_connections=20
            )
        )

    async def request(self, method: str, url: str, **kwargs):
        return await self.client.request(method, url, **kwargs)
```

**è¿ç§»æ³¨æ„äº‹é¡¹**:
- âœ… å®Œæ•´å¤åˆ¶ï¼Œä¿æŒè¿æ¥æ± é…ç½®

---

### 5.3 æœ¬åœ° MCP Serversï¼ˆå¿…é¡»æ‰“åŒ…ï¼‰

#### 5.3.1 Common Tools MCP

**ç›®å½•**: `backend/mcp/common_tools_mcp_server/` â†’ `mcp/common_tools/`

**æ–‡ä»¶æ¸…å•**:
```
common_tools_mcp_server/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ server.py  (MCP Server å…¥å£)
â””â”€â”€ tools/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ time_utils.py  (get_current_time, get_today_date)
    â””â”€â”€ ...
```

**æä¾›çš„å·¥å…·**:
- `get_current_time()` - è·å–å½“å‰æ—¶é—´
- `get_today_date()` - è·å–ä»Šæ—¥æ—¥æœŸ
- å…¶ä»–é€šç”¨å·¥å…·

**è¿ç§»æ³¨æ„äº‹é¡¹**:
- âœ… å®Œæ•´å¤åˆ¶æ•´ä¸ªç›®å½•
- âœ… ä¿æŒç›®å½•ç»“æ„

#### 5.3.2 Alert MCP

**ç›®å½•**: `backend/mcp/alert_mcp_server/` â†’ `mcp/alert/`

**æä¾›çš„å·¥å…·**:
- `list_alerts()` - åˆ—å‡ºå‘Šè­¦è§„åˆ™
- `create_alert()` - åˆ›å»ºå‘Šè­¦
- `update_alert()` - æ›´æ–°å‘Šè­¦
- `delete_alert()` - åˆ é™¤å‘Šè­¦
- `execute_alert()` - æ‰§è¡Œå‘Šè­¦æ£€æµ‹

**è¿ç§»æ³¨æ„äº‹é¡¹**:
- âœ… å®Œæ•´å¤åˆ¶æ•´ä¸ªç›®å½•
- âš ï¸ éœ€è¦æ•°æ®åº“è¿æ¥ï¼ˆè¯»å– Alert è¡¨ï¼‰

#### 5.3.3 Send Email MCP

**ç›®å½•**: `backend/mcp/send_email_mcp_server/` â†’ `mcp/send_email/`

**æä¾›çš„å·¥å…·**:
- `send_email()` - å‘é€é‚®ä»¶ï¼ˆé€šè¿‡ AWS SESï¼‰

**ä¾èµ–**:
- AWS SES æƒé™
- é‚®ä»¶æ¨¡æ¿

**è¿ç§»æ³¨æ„äº‹é¡¹**:
- âœ… å®Œæ•´å¤åˆ¶æ•´ä¸ªç›®å½•
- âœ… ç¡®ä¿ SES æƒé™æ­£ç¡®

#### 5.3.4 GCP Cost MCP

**ç›®å½•**: `backend/mcp/gcp_cost_mcp_server/` â†’ `mcp/gcp_cost/`

**æä¾›çš„å·¥å…·**:
- `get_gcp_cost_by_service()` - æŒ‰æœåŠ¡æŸ¥è¯¢ GCP æˆæœ¬
- `get_gcp_cost_by_project()` - æŒ‰é¡¹ç›®æŸ¥è¯¢ GCP æˆæœ¬
- `get_gcp_cud_coverage()` - CUD è¦†ç›–ç‡åˆ†æ
- `get_gcp_cud_recommendations()` - CUD æ¨è

**ä¾èµ–**:
- GCP BigQuery API
- GCP Recommender API
- GCP Service Account å‡­è¯

**è¿ç§»æ³¨æ„äº‹é¡¹**:
- âœ… å®Œæ•´å¤åˆ¶æ•´ä¸ªç›®å½•
- âœ… ç¡®ä¿ GCP å‡­è¯ä¼ é€’æ­£ç¡®

---

### 5.4 å®˜æ–¹ MCP Serversï¼ˆPyPI åŒ…ï¼‰

ä»¥ä¸‹ MCP Server é€šè¿‡ PyPI å®‰è£…ï¼Œä¸éœ€è¦å¤åˆ¶ä»£ç ï¼š

- âœ… `pricing` â†’ `aws_pricing` (å®˜æ–¹åŒ…)
- âœ… `documentation` â†’ `aws_documentation` (å®˜æ–¹åŒ…)

**requirements.txt**:
```txt
# å®˜æ–¹ MCP Servers
aws-pricing-mcp-server
aws-documentation-mcp-server
```

---

### 5.5 Gateway MCP Serversï¼ˆè¿œç¨‹éƒ¨ç½²ï¼‰

ä»¥ä¸‹ MCP Server å·²æ‹†åˆ†åˆ°ç‹¬ç«‹ä»“åº“ï¼Œé€šè¿‡ AgentCore Gateway æä¾›æœåŠ¡ï¼Œ**ä¸éœ€è¦**åœ¨ Agent ä»“åº“ä¸­åŒ…å«ä»£ç ï¼š

| MCP Server | çŠ¶æ€ | è¯´æ˜ |
|-----------|------|------|
| `billing-cost-management` | âœ… å·²æ‹†åˆ† | æˆæœ¬ä¼˜åŒ–å’Œç®¡ç† |
| `risp` | âœ… å·²æ‹†åˆ† | RI/SP åˆ†æ |
| `cloudtrail` | âœ… å·²æ‹†åˆ† | CloudTrail æ—¥å¿—æŸ¥è¯¢ |

**Agent ä»“åº“é…ç½®**ï¼ˆ`config/settings.py`ï¼‰ï¼š
```python
# Gateway MCP æœåŠ¡å™¨åˆ—è¡¨
AWS_GATEWAY_MCP_SERVERS = [
    "billing-cost-management",
    "risp",
    "cloudtrail",
]

# Gateway ç«¯ç‚¹ URL
COSTQ_AWS_MCP_SERVERS_GATEWAY_URL = "https://xxx.gateway.bedrock-agentcore.ap-northeast-1.amazonaws.com/mcp"

# SigV4 ç­¾åé…ç½®
GATEWAY_SERVICE = "bedrock-agentcore"
AWS_REGION = "ap-northeast-1"
```

**è¿æ¥æ–¹å¼**ï¼š
- ä½¿ç”¨ HTTP + SigV4 ç­¾åè®¤è¯
- è‡ªåŠ¨ä½¿ç”¨ Runtime IAM Roleï¼ˆä¸ä½¿ç”¨æŸ¥è¯¢è´¦å·å‡­è¯ï¼‰
- é€šè¿‡ `StreamableHTTPSigV4Transport` å»ºç«‹è¿æ¥

**è¿ç§»è¯´æ˜**ï¼š
- âœ… è¿™äº› MCP çš„ä»£ç å·²ä»å•ä½“ä»“åº“è¿å‡ºå¹¶åœ¨ Gateway ç‹¬ç«‹ç»´æŠ¤
- âœ… Agent ä»…éœ€é…ç½® Gateway URL å’ŒæœåŠ¡å
- âœ… æ— éœ€è¿ç§»ä»»ä½•ä»£ç åˆ°æ–°çš„ Agent ä»“åº“

---

## 6. å·²åºŸå¼ƒæ–‡ä»¶ï¼ˆä»…è®°å½•ï¼Œä¸åœ¨ monorepo åˆ é™¤ï¼‰

### 6.1 å·²åºŸå¼ƒçš„ Agent ä»£ç ï¼ˆä»…è®°å½•ï¼Œmonorepo ä¸åšåˆ é™¤æ“ä½œï¼‰

```
backend/agent/
â”œâ”€â”€ streaming_agent.py  âŒ ä¿ç•™ï¼ˆå·²è¢« AgentCore Runtime æ›¿ä»£ï¼‰
â””â”€â”€ alert_agent.py      âŒ ä¿ç•™ï¼ˆå·²åˆå¹¶åˆ° agent_runtime.pyï¼‰
```

### 6.2 å·²åºŸå¼ƒçš„ API ä»£ç ï¼ˆä»…è®°å½•ï¼Œmonorepo ä¸åšåˆ é™¤æ“ä½œï¼‰

```
backend/api/
â””â”€â”€ http.py  âŒ ä¿ç•™ï¼ˆå·²è¢« SSE æ›¿ä»£ï¼‰
```

### 6.3 å·²åºŸå¼ƒçš„ MCP ç®¡ç†ä»£ç ï¼ˆä»…è®°å½•ï¼Œmonorepo ä¸åšåˆ é™¤æ“ä½œï¼‰

```
backend/mcp/
â””â”€â”€ dynamic_clients.py  âŒ ä¿ç•™ï¼ˆå·²ç®€åŒ–ä¸º mcp_manager.pyï¼‰
```

---

## 7. Backend ä¿ç•™çš„æ–‡ä»¶

### 7.1 API è·¯ç”±ï¼ˆä»… Backend ä¿ç•™ï¼‰

```
backend/api/
â”œâ”€â”€ sse.py  âœ… ä¿ç•™ï¼ˆSSE æŸ¥è¯¢ç«¯ç‚¹ï¼‰
â”œâ”€â”€ agent_provider.py  âœ… ä¿ç•™ï¼ˆAgent æä¾›è€…æŠ½è±¡å±‚ï¼‰
â”œâ”€â”€ agentcore_response_parser.py  âœ… ä¿ç•™ï¼ˆè§£æ Runtime SSE äº‹ä»¶ï¼‰
â”œâ”€â”€ auth.py  âœ… ä¿ç•™ï¼ˆç”¨æˆ·è®¤è¯ï¼‰
â”œâ”€â”€ profile.py  âœ… ä¿ç•™ï¼ˆç”¨æˆ·ä¿¡æ¯ï¼‰
â”œâ”€â”€ accounts.py  âœ… ä¿ç•™ï¼ˆAWS è´¦å· CRUDï¼‰
â”œâ”€â”€ gcp_accounts.py  âœ… ä¿ç•™ï¼ˆGCP è´¦å· CRUDï¼‰
â”œâ”€â”€ chat.py  âœ… ä¿ç•™ï¼ˆèŠå¤©å†å²ï¼‰
â”œâ”€â”€ alerts.py  âœ… ä¿ç•™ï¼ˆå‘Šè­¦ç®¡ç† APIï¼‰
â”œâ”€â”€ users.py  âœ… ä¿ç•™ï¼ˆç”¨æˆ·ç®¡ç†ï¼‰
â””â”€â”€ monitoring.py  âœ… ä¿ç•™ï¼ˆç›‘æ§ APIï¼‰
```

### 7.2 æœåŠ¡å±‚ï¼ˆä»… Backend ä¿ç•™ï¼‰

```
backend/services/
â”œâ”€â”€ agentcore_client.py  âœ… ä¿ç•™ï¼ˆè°ƒç”¨ AgentCore Runtimeï¼‰
â”œâ”€â”€ chat_storage_*.py  âœ… ä¿ç•™ï¼ˆèŠå¤©è®°å½•å­˜å‚¨ï¼‰
â”œâ”€â”€ audit_logger.py  âœ… ä¿ç•™ï¼ˆå®¡è®¡æ—¥å¿—ï¼‰
â”œâ”€â”€ alert_scheduler.py  âœ… ä¿ç•™ï¼ˆå‘Šè­¦è°ƒåº¦å™¨ï¼‰
â”œâ”€â”€ email_service.py  âœ… ä¿ç•™ï¼ˆé‚®ä»¶æœåŠ¡ï¼‰
â”œâ”€â”€ user_storage_*.py  âœ… ä¿ç•™ï¼ˆç”¨æˆ·å­˜å‚¨ï¼‰
â”œâ”€â”€ account_storage_*.py  âœ… ä¿ç•™ï¼ˆè´¦å·å­˜å‚¨ CRUDï¼‰
â””â”€â”€ resource_manager.py  âœ… ä¿ç•™ï¼ˆå¹¶å‘é™åˆ¶ï¼‰
```

### 7.3 æ•°æ®åº“æ¨¡å‹ï¼ˆä»… Backend ä¿ç•™ï¼‰

```
backend/models/
â”œâ”€â”€ user.py  âœ… ä¿ç•™ï¼ˆç”¨æˆ·æ¨¡å‹ï¼‰
â”œâ”€â”€ chat_session.py  âœ… ä¿ç•™ï¼ˆèŠå¤©ä¼šè¯ï¼‰
â”œâ”€â”€ chat_message.py  âœ… ä¿ç•™ï¼ˆèŠå¤©æ¶ˆæ¯ï¼‰
â”œâ”€â”€ alert.py  âœ… ä¿ç•™ï¼ˆå‘Šè­¦è§„åˆ™ï¼‰
â””â”€â”€ prompt_template.py  âœ… ä¿ç•™ï¼ˆæç¤ºè¯æ¨¡æ¿ï¼‰
```

---

## 8. è¿ç§»æ£€æŸ¥æ¸…å•

### 8.1 ä»£ç æ–‡ä»¶è¿ç§»

- [ ] Agent æ ¸å¿ƒä»£ç 
  - [ ] `agent_runtime.py` â†’ `agent/runtime.py`
  - [ ] `agent_manager.py` â†’ `agent/manager.py`
  - [ ] `prompts/` â†’ `agent/prompts/`
- [ ] é…ç½®æ¨¡å—
  - [ ] `config/settings.py` â†’ `config/settings.py`ï¼ˆç²¾ç®€ç‰ˆï¼‰
  - [ ] `config/aws_secrets.py` â†’ `config/aws_secrets.py`
- [ ] æ•°æ®åº“æ¨¡å—
  - [ ] `database.py` â†’ `database/connection.py`
  - [ ] `models/aws_account.py` â†’ `database/models/aws_account.py`
  - [ ] `models/gcp_account.py` â†’ `database/models/gcp_account.py`
- [ ] æœåŠ¡å±‚
  - [ ] `services/credential_manager.py`
  - [ ] `services/gcp_credential_manager.py`
  - [ ] `services/iam_role_session_factory.py`
  - [ ] `services/streamable_http_sigv4.py`
  - [ ] `utils/aws_session_factory.py`
  - [ ] `utils/env_isolation_validator.py`
- [ ] MCP æ¨¡å—
  - [ ] `mcp/mcp_manager.py` â†’ `mcp/manager.py`
  - [ ] `mcp/connection_pool.py`
  - [ ] `mcp/common_tools_mcp_server/` â†’ `mcp/common_tools/`
  - [ ] `mcp/alert_mcp_server/` â†’ `mcp/alert/`
  - [ ] `mcp/send_email_mcp_server/` â†’ `mcp/send_email/`
  - [ ] `mcp/gcp_cost_mcp_server/` â†’ `mcp/gcp_cost/`

### 8.2 ä¾èµ–åŒ…è¿ç§»

- [ ] æ ¸å¿ƒä¾èµ–
  - [ ] `strands-agents`
  - [ ] `bedrock-agentcore`
  - [ ] `boto3`
  - [ ] `mcp`
  - [ ] `sqlalchemy`
  - [ ] `psycopg2-binary`
- [ ] MCP ä¾èµ–
  - [ ] `httpx`
  - [ ] `aws_pricing`
  - [ ] `aws_documentation`
- [ ] GCP ä¾èµ–
  - [ ] `google-cloud-billing`
  - [ ] `google-cloud-bigquery`
  - [ ] `google-cloud-recommender`
- [ ] å·¥å…·ä¾èµ–
  - [ ] `cryptography`ï¼ˆFernet åŠ å¯†ï¼‰
  - [ ] `python-dotenv`ï¼ˆ.env æ”¯æŒï¼‰
  - [ ] `pydantic`ï¼ˆé…ç½®éªŒè¯ï¼‰

### 8.3 é…ç½®éªŒè¯

- [ ] ç¯å¢ƒå˜é‡
  - [ ] `BEDROCK_MODEL_ID`
  - [ ] `BEDROCK_REGION`
  - [ ] `BEDROCK_CROSS_ACCOUNT_ROLE_ARN`
  - [ ] `MEMORY_RESOURCE_ID`
  - [ ] `RDS_SECRET_NAME`
  - [ ] `ENCRYPTION_KEY`
  - [ ] `AWS_REGION`
  - [ ] `AGENTCORE_RUNTIME_ARN`
  - [ ] `COSTQ_AWS_MCP_SERVERS_GATEWAY_URL`
- [ ] MCP é…ç½®
  - [ ] `AWS_MCP_SERVERS` åˆ—è¡¨
  - [ ] `AWS_GATEWAY_MCP_SERVERS` åˆ—è¡¨
  - [ ] `GCP_MCP_SERVERS` åˆ—è¡¨

### 8.4 æ—§ä»“åº“å¤„ç½®ï¼ˆä»…è®°å½•ï¼‰

- [ ] monorepo ä¸åšåˆ é™¤æ“ä½œï¼Œä¿æŒç°çŠ¶
- [ ] æ–°ä»“åº“ç¨³å®šåï¼Œæ—§ä»“åº“æ•´ä½“æ ‡è®°ä¸ºåºŸå¼ƒå¹¶åœæ­¢æ¼”è¿›

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2026-01-23
**ä½œè€…**: AI Assistant
